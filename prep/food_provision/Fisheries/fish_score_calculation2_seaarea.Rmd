---
title: "Calculation of fisheries sustainability score"
author: "Marina Espinasse"
date: "`r Sys.Date()`"
output:
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true

---

```{r message = FALSE}
library(readxl)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(ggthemes)
library(scales)
library(zoo)
```

# Importing formatted catches and stocks data
```{r }
ices <- read.csv("data/ices_stock_stats.csv")
catch <- read.csv("data/fish_catch_by_municipality.csv")
seaarea <-read_excel("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/KommArea.xlsx")
```

# Merging catch data with ICES stocks data
```{r warning=FALSE}
fish_nor <-catch %>% 
           mutate(English = as.character(English)) %>% 
           mutate(English = replace(English, English == "Atlantic cod", "Cod")) %>% 
           mutate(English = replace(English, English == "Atlantic herring", "Herring")) %>% 
           mutate(English = replace(English, English == "Red king crab", "Kingcrab")) %>% 
           mutate(Spp_year = paste(English,Year, sep = "_")) %>% 
           left_join(ices[,c(3,4,5,6,7)], by = "Spp_year") %>% 
           rename("Species" = "English") 
```

Checking the number of data points per species
```{r}
fish_nor %>% group_by(Species) %>% 
             summarize(n = n())
```


# Further data cleaning: removing and re-arranging locations 

Deleting municipalities that are not in the study (Beiarn county and Guovdageaidnu-Kautokeino)
Re-estimating landings for the municipalities that were merged (Bodo + Skjerstad_2005, Bjarkoy_2013 + Harstad_2013) - I sum the landings for these pairs of municipalities for the years before they've merged. 
```{r}
fish_nor_prep <- fish_nor %>% 
                  mutate(Municip_name = as.character(Municip_name)) %>% 
                  filter(!Municip_name %in% c("Beiarn", "Guovdageaidnu-Kautokeino")) %>% #mind the correct spelling of Guo... county
                  mutate(newid = case_when(Municip_name %in% c("Harstad_2013", "Bjarkoy_2013") ~ "1",
                                           Municip_name %in% c("Bodo", "Skjerstad_2005") ~ "2",
                                           TRUE ~ Municip_name)) %>% 
                  group_by(newid, Year, Species) %>% 
                  mutate(Total_catch_new = sum(Total_catch))
```

And now update the whole table, aggregate landings over counties that were merged, remove Skjerstad_2005 and Bjarkoy_2013.
In this table, *Municip_name_new* are the names of the municipalities after they've merged. *Total_catch_new* is the total fish landings after municipalities merging.
```{r}
fish_nor_prep2<- fish_nor_prep %>% 
                  select(-c("Municip_name", "Total_catch")) %>% 
                  mutate(Municip_name_new = newid) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "1", "Harstad")) %>% 
                  mutate(Municip_number = replace(Municip_number, Municip_name_new == "Harstad", "1903")) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "2", "Bodo")) %>% 
                  mutate(Municip_number = replace(Municip_number, Municip_name_new == "Bodo", "1804")) %>% 
                  ungroup() %>% 
                  select(-newid) %>% 
                  select(1,2,10,3:9)
```


# Estimating sustainability score for each of the fish stocks
```{r}
fish_nor_estim <-fish_nor_prep2 %>% 
                 mutate(Blim.Bmsy = Blim/Bmsy)

fish_nor_score <-fish_nor_estim %>% #estimating sustainability score for each stock (each species) - variable  "stock_score"
                 mutate(stock_score = case_when(
                                    SSB.Bmsy >= 1 ~ 1,
                                    SSB.Bmsy < 1 & SSB.Bmsy > Blim.Bmsy ~ (SSB.Bmsy - Blim.Bmsy)/Blim.Bmsy,
                                    SSB.Bmsy <= Blim.Bmsy ~ 0
                                    ))
```

# Estimating biomass weighted score and final fisheries score in Northern Norway 
(Check fisheries README. for details)
```{r}
seaarea <- seaarea %>% 
          mutate(Komnum = as.character(Komnum))   

weighted_biomass_score <- fish_nor_score %>% #biomass per area weighted by maximal biomass per area
                         left_join(seaarea[,c("Havflate", "Komnum")], by = c("Municip_number" = "Komnum")) %>% 
                         rename("Seaarea" = "Havflate") %>% 
                         mutate(biomass.area = Total_catch_new/Seaarea) %>% 
                         group_by(Municip_name_new) %>% 
                         mutate(max.biomass.area = max(biomass.area)) %>% 
                         ungroup() %>%  
                         mutate(weighted.biomas.sc = (biomass.area*stock_score)/max.biomass.area) %>%  
                         filter(!Species == "Kingcrab")#exclude king crab, it does not have SSB, Bmsy and Blim



#write_csv(weighted_biomass_score, "data/weighted_biomass_score.csv")

                                                 
final_scores_area <- weighted_biomass_score %>%
                  group_by(Year, Municip_number, Municip_name_new) %>% 
                  mutate(total_tons = sum(Total_catch_new)) %>%
                  mutate(catch_prop = Total_catch_new/total_tons) %>% 
                  summarize(fish_score = sum(weighted.biomas.sc*catch_prop*100))
                 
#write_csv(final_scores_area, "data/fishery_final_area.csv") 
```

Quick-check of the distribution of area-weighted final score
```{r}
plot<- ggplot(final_scores_area, ) +
        geom_density(aes(fish_score), fill = "blue", color = "navy", alpha = 0.7)
                
```

```{r}
mosaic::fav_stats(final_scores_area$fish_score)                
```



