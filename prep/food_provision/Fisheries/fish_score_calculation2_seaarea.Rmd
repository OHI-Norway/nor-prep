---
title: "Calculation of fisheries sustainability score"
author: "Marina Espinasse"
date: "`r Sys.Date()`"
output:
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r message = FALSE}
library(stringr)
library(ggthemes)
library(scales)
library(zoo)
library(ggridges)
library(kableExtra)
```

# Importing formatted catches and stocks data
```{r }
ices <- read.csv("data/ices_stock_stats.csv")
catch <- read.csv("data/fish_catch_by_municipality.csv")
seaarea <-read_excel(file.path(dir_M[2], "Fishery/DeliveryDataFiskDir/KommArea.xlsx"))
```

# Merging catch data with ICES stocks data
```{r warning=FALSE}
fish_nor <-catch %>% 
           mutate(English = as.character(English)) %>% 
           mutate(English = replace(English, English == "Atlantic cod", "Cod")) %>% 
           mutate(English = replace(English, English == "Atlantic herring", "Herring")) %>% 
           mutate(English = replace(English, English == "Red king crab", "Kingcrab")) %>% 
           mutate(Spp_year = paste(English,Year, sep = "_")) %>% 
           left_join(ices[,c(3,4,5,6,7)], by = "Spp_year") %>% 
           rename("Species" = "English") 
```

Checking the number of data points per species
```{r}
fish_nor %>% group_by(Species) %>% 
             summarize(n = n())
```


# Further data cleaning: removing and re-arranging locations 
Deleting municipalities that are not in the study (Beiarn county and Guovdageaidnu-Kautokeino)
Re-estimating landings for the municipalities that were merged (Bodo + Skjerstad_2005, Bjarkoy_2013 + Harstad_2013) - I sum the landings for these pairs of municipalities for the years before they've merged. 
```{r}
fish_nor_prep <- fish_nor %>% 
                  mutate(Municip_name = as.character(Municip_name)) %>% 
                  filter(!Municip_name %in% c("Beiarn", "Guovdageaidnu-Kautokeino")) %>% #mind the correct spelling of Guo... county
                  mutate(newid = case_when(Municip_name %in% c("Harstad_2013", "Bjarkoy_2013") ~ "1",
                                           Municip_name %in% c("Bodo", "Skjerstad_2005") ~ "2",
                                           TRUE ~ Municip_name)) %>% 
                  group_by(newid, Year, Species) %>% 
                  mutate(Total_catch_new = sum(Total_catch))
```

And now update the whole table, aggregate landings over counties that were merged, remove Skjerstad_2005 and Bjarkoy_2013.
In this table, *Municip_name_new* are the names of the municipalities after they've merged. *Total_catch_new* is the total fish landings after municipalities merging.
```{r}
fish_nor_prep2<- fish_nor_prep %>% 
                  select(-c("Municip_name", "Total_catch")) %>% 
                  mutate(Municip_name_new = newid) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "1", "Harstad")) %>% 
                  mutate(Municip_number = replace(Municip_number, Municip_name_new == "Harstad", "1903")) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "2", "Bodo")) %>% 
                  mutate(Municip_number = replace(Municip_number, Municip_name_new == "Bodo", "1804")) %>% 
                  ungroup() %>% 
                  select(-newid) %>% 
                  select(1,2,10,3:9)
```


# Estimating sustainability score for each of the fish stocks
```{r}
fish_nor_estim <-fish_nor_prep2 %>% 
                 mutate(Blim.Bmsy = Blim/Bmsy)

fish_nor_score <-fish_nor_estim %>% #estimating sustainability score for each stock (each species) - variable  "stock_score"
                 mutate(stock_score = case_when(
                                    SSB.Bmsy >= 1 ~ 1,
                                    SSB.Bmsy < 1 & SSB.Bmsy > Blim.Bmsy ~ (SSB.Bmsy - Blim.Bmsy)/Blim.Bmsy,
                                    SSB.Bmsy <= Blim.Bmsy ~ 0
                                    ))
```

# Examing the distribution of total catch by species regardless of municipality
```{r}
catch_dist <-ggplot(data =fish_nor_score)+
   geom_density_ridges(aes(y = Species, x = Year, fill = Species))+
  scale_x_continuous(breaks = seq(1992,2018,4))+
  labs(x = "")+
   scale_fill_viridis_d(option = "D", alpha = 0.6)+
  
    theme_igray()
catch_dist
```

# Estimating cacth per area and maximal weighted catch
(Check fisheries README. for details). This approach however, has a danger of positive  outliers dominating 
the maximal catch per area. Due to multiple reasons, catch will vary in every municipality for each stock from year to year. Thus, a maximal catch (biomass) per area can be just an outlier, a seldomly seen very high catch. This is also seen in that most of the biomass.area/max.biomass.area ratios are very low (90% are less than 0.2).
```{r}
seaarea <- seaarea %>% 
          mutate(Komnum = as.character(Komnum))   

weighted_biomass_score <- fish_nor_score %>% #biomass per area weighted by maximal biomass per area
                          left_join(seaarea[,c("Havflate", "Komnum")], by = c("Municip_number" = "Komnum")) %>% 
                         rename("Seaarea" = "Havflate") %>% 
                         mutate(biomass.area = Total_catch_new/Seaarea) %>% 
                         group_by(Species) %>% 
                         mutate(max.biomass.area = max(biomass.area)) %>% 
                         ungroup() %>% 
                         mutate(weighted.biomass = biomass.area/max.biomass.area) %>% 
                         mutate(weighted.biomass.sc = weighted.biomass*stock_score)
```


# Re-estimate weighted catch per area based on smoothed catches
## Apply 3-years rolling mean on catch data
Rolling mean is a remedy against inter-annual variability in catches and against influential outliers. 
I apply 3-year rolliing mean to catch data. However,rolling mean does not help to smooth variability in catches between the municipalities.
```{r}
municipalities <-unique(fish_nor_score$Municip_name_new)
species <-unique(fish_nor_score$Species)

splist <-list()
finallist <-list()
for (i in 1:length(municipalities)) 
  {
   mp <- municipalities[i]
   df.mp <- fish_nor_score %>% 
      filter(Municip_name_new == mp)
    for (j in 1:length(species))
     {
        sp <- species[j]
        df.sp <- df.mp %>% 
            filter(Species == sp)
  
      runmean <-data.frame(catch_runmean = rollapply(df.sp$Total_catch_new, width = 3, FUN = mean,  fill=NA))
      df.sp.full <- bind_cols(df.sp, runmean)
      splist[[j]] <- df.sp.full
      smoothed_catches_spp <- do.call("rbind", splist)
      finallist[[i]] <-smoothed_catches_spp
    
    }
   
 }
 
smoothed_catches <- do.call("rbind", finallist)
colSums(is.na(smoothed_catches)) 
```

## Re-esitmate weighted catch per area based on smoothed catches
```{r}
smoothed_weighted_biomass_score <- smoothed_catches %>% 
                         left_join(seaarea[,c("Havflate", "Komnum")], by = c("Municip_number" = "Komnum")) %>% 
                         rename("Seaarea" = "Havflate") %>% 
                         filter(!is.na(catch_runmean)) %>% 
                         mutate(biomass.area = catch_runmean/Seaarea) %>% 
                         group_by(Species) %>% 
                         mutate(max.biomass.area = max(biomass.area)) %>% 
                         ungroup() %>% 
                         mutate(weighted.biomass = biomass.area/max.biomass.area) %>% 
                         mutate(weighted.biomass.sc = weighted.biomass*stock_score)

```

# Check the distribution of biomass/area for each stock
## Plot smoothed catches on a boxplot
```{r}
plot2<- ggplot(smoothed_weighted_biomass_score) +
  geom_boxplot(aes(Species, biomass.area), color = "darkgreen", alpha = 0.7, fill = "transparent", outlier.color = "red") +
  labs(x = "")

#And a trucnated version
plot3<- ggplot(smoothed_weighted_biomass_score) +
  geom_boxplot(aes(Species, biomass.area), color = "darkgreen", alpha = 0.7, fill = "transparent", outlier.color = "red") +
  scale_y_continuous(limits = c(0,50))+
  labs(x = "")
  
plot2
plot3
  
```

## Summarize smoothed catches in a table
```{r}  
species <-unique(smoothed_weighted_biomass_score$Species)

outputdf <- list()
for (i in 1:length(species))
  {
   sp <- species[i]
   spdf <- filter(smoothed_weighted_biomass_score, Species == sp)
   stats <- mosaic::fav_stats(spdf$biomass.area)
   allstats <-cbind(stats, Species = rep(sp, 1))
   outputdf[[i]] <- allstats
}

biomass.area.favstats <- do.call("rbind", outputdf)

newtable <- biomass.area.favstats %>%  
    mutate(Species = cell_spec(
    Species, color = "white", bold = T,
    background = spec_color(1:6, end = 0.9, option = "A", direction = -1))) %>% 
    mutate(max = round(max, 2)) %>% 
    mutate(max = cell_spec(
    as.numeric(max), "html", 
    color = ifelse(max > 90, "red", "blue"))) %>% 
    kable(escape = F, align = "c", digits = 4) %>%
    kable_styling(c("striped", "condensed"), full_width = F) %>% 
    column_spec(1:10,bold = T,background = "azure", color = "darkgreen")
newtable
```


# Calculate final fisheries scores based smoothed weighted catches per area
```{r}
final_scores_smoothed_area <- smoothed_weighted_biomass_score %>%
                  group_by(Year, Municip_number, Municip_name_new) %>% 
                  mutate(total_tons = sum(catch_runmean)) %>%
                  mutate(catch_prop = catch_runmean/total_tons) %>% 
                  summarize(fish_score = sum(weighted.biomass.sc*catch_prop*100))
                 
#write_csv(final_scores_smoothed_area, "data/fishery_final_score_smoothed_by_area.csv") 
```

# Quick-check of the distribution of area-weighted final score 
```{r}
mosaic::fav_stats(final_scores_smoothed_area$fish_score)       
plot<- ggplot(final_scores_smoothed_area) +
        geom_density(aes(fish_score), fill = "blue", color = "navy", alpha = 0.7)
plot 
```


# Option: applying rolling mean to the final fisheries score based on non-smoothed catches
(if not applying rolling mean already on catches)
```{r}
municipalities <-unique(fish_nor_score$Municip_name_new)

finallist2 <- list()
for (i in 1:length(municipalities))
{
  mp <- municipalities[i]
  dfmp <- final_scores_area %>%
    filter(Municip_name_new == mp)
  runmean <- data.frame(runmean = rollapply(dfmp$fish_score, width = 5, FUN = mean, fill = NA)) # 5 steps rolling mean has a better effect than 3-steps
  dfall <- bind_cols(dfmp, runmean)
  finallist2[[i]] <- dfall
}
smoothed_final_scores <- do.call("rbind", finallist2)
colSums(is.na(smoothed_final_scores)) 

```

# Using 0.75th quartile of catch per area as a target
```{r}
smoothed_weighted_biomass_score_quantile <- smoothed_catches %>% 
                         left_join(seaarea[,c("Havflate", "Komnum")], by = c("Municip_number" = "Komnum")) %>% 
                         rename("Seaarea" = "Havflate") %>% 
                         filter(!is.na(catch_runmean)) %>% 
                         mutate(biomass.area = catch_runmean/Seaarea) %>% 
                         group_by(Species) %>% 
                         mutate(biomass.area.q75 =quantile(biomass.area, probs = 0.75)) %>% 
                         ungroup() %>% 
                         mutate(weighted.biomass = ifelse(
                           biomass.area > biomass.area.q75, 1, biomass.area/biomass.area.q75)) %>% 
                         mutate(weighted.biomass.sc = weighted.biomass*stock_score)
```

# Recalcualte fisheries score based on 0.75th quartile of catch as a reference
```{r}
final_scores_smoothed_area_q75 <- smoothed_weighted_biomass_score_quantile %>%
                  group_by(Year, Municip_number, Municip_name_new) %>% 
                  mutate(total_tons = sum(catch_runmean)) %>%
                  mutate(catch_prop = catch_runmean/total_tons) %>% 
                  summarize(fish_score = sum(weighted.biomass.sc*catch_prop*100))
```

# Quick-check of the distribution of area-weighted final score based on 0.75th qunatile
```{r}
mosaic::fav_stats(final_scores_smoothed_area_q75$fish_score)       
plot4<- ggplot(final_scores_smoothed_area_q75) +
        geom_density(aes(fish_score), fill = "blue", color = "navy", alpha = 0.7)
plot4 
```