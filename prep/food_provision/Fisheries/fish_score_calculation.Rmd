---
title: "Calculation of fisheries sustainability score"
author: "Marina Espinasse"
date: "`r Sys.Date()`"
output:
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true

---

```{r message = FALSE}
library(readxl)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(ggthemes)
library(scales)
library(zoo)
```

# Importing formatted catches and stocks data
```{r }
ices <- read.csv("data/ices_stock_stats.csv")
catch <- read.csv("data/fish_catch_by_municipality.csv")
```

# Merging catch data with ICES stocks data
```{r warning=FALSE}
fish_nor <-catch %>% 
           mutate(English = as.character(English)) %>% 
           mutate(English = replace(English, English == "Atlantic cod", "Cod")) %>% 
           mutate(English = replace(English, English == "Atlantic herring", "Herring")) %>% 
           mutate(English = replace(English, English == "Red king crab", "Kingcrab")) %>% 
           mutate(Spp_year = paste(English,Year, sep = "_")) %>% 
           left_join(ices[,c(3,4,5,6,7)], by = "Spp_year") %>% 
           rename("Species" = "English") 
```

Checking the number of data points per species
```{r}
fish_nor %>% group_by(Species) %>% 
             summarize(n = n())
```


# Further data cleaning: removing and re-arranging locaitons

Deleting municipalities that are not in the study (Beiarn county and Guovdageaidnu-Kautokeino)
Re-estimating landings for the municipalities that were merged (Bodo + Skjerstad_2005, Bjarkoy_2013 + Harstad_2013) - I sum the landings for these pairs of municipalities for the years before they've merged. 
```{r}
fish_nor_prep <- fish_nor %>% 
                  mutate(Municip_name = as.character(Municip_name)) %>% 
                  filter(!Municip_name %in% c("Beiarn", "Guovdageaidnu-Kautokeino")) %>% #mind the correct spelling of Guo... county
                  mutate(newid = case_when(Municip_name %in% c("Harstad_2013", "Bjarkoy_2013") ~ "1",
                                           Municip_name %in% c("Bodo", "Skjerstad_2005") ~ "2",
                                           TRUE ~ Municip_name)) %>% 
                  group_by(newid, Year, Species) %>% 
                  mutate(Total_catch_new = sum(Total_catch))
```

And now update the whole table, aggregate landings over counties that were merged, remove Skjerstad_2005 and Bjarkoy_2013.
In this table, *Municip_name_new* are the names of the municipalities after they've merged. *Total_catch_new* is the total fish landings after municipalities merging.
```{r}
fish_nor_prep2<- fish_nor_prep %>% 
                  select(-c("Municip_name", "Total_catch")) %>% 
                  mutate(Municip_name_new = newid) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "1", "Harstad")) %>% 
                  mutate(Municip_name_new = replace(Municip_name_new, Municip_name_new == "2", "Bodo")) %>% 
                  ungroup() %>% 
                  select(c(1,2,11,3:8,10))
```


# Estimating sustainability score for each of the fish stocks
```{r}
fish_nor_estim <-fish_nor_prep2 %>% 
                 mutate(Blim.Bmsy = Blim/Bmsy)

fish_nor_score <-fish_nor_estim %>% #estimating sustainability score for each stock (each species) - variable  "stock_score"
                 mutate(stock_score = case_when(
                                    SSB.Bmsy >= 1 ~ 1,
                                    SSB.Bmsy < 1 & SSB.Bmsy > Blim.Bmsy ~ (SSB.Bmsy - Blim.Bmsy)/Blim.Bmsy,
                                    SSB.Bmsy <= Blim.Bmsy ~ 0
                                    ))

write_csv(fish_nor_score, "sustain_score.csv")
```

# Estimating catch weighted score and final fisheries score in Northern Norway 
(Check fisheries README. for details)
```{r}
fish_nor_weight <- fish_nor_score %>% #adding total weight of the catch for all stock per municipality and proportion of each stock
                   group_by(Year, Municip_number, Municip_name_new) %>%
                   mutate(total_tons = sum(Total_catch_new)) %>%
                   ungroup() %>%
                   mutate(catch_prop = Total_catch_new/total_tons,
                   catch_weighted_score = catch_prop*stock_score)

write_csv(fish_nor_weight, "catch_weighted_score.csv")

final_scores <- fish_nor_weight %>%
                  group_by(Year, Municip_number, Municip_name_new) %>%
                  summarize(fish_score = sum(catch_weighted_score)*100)

write_csv(final_scores, "fishery_final_score.csv")

```


