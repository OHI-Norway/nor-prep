---
title: "Cleaning fish catch data for fisheries goal estimation"
author: "Marina Espinasse"
date: "`r Sys.Date()`"
output:
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true

---

```{r include=FALSE}
library(readxl)
library(readr)
library(dplyr)
library(stringr)
library(kableExtra)
```

# Loading fish landings data (1994 - 2017) for Northern Norway 
```{r}
#/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/Fisk0017.csv
temp_catch17 <- read.csv("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/Fisk0017.csv", sep = ";")
temp_catch99 <- read.csv("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/Fisk9499.csv", sep = ";")
names<-read.csv("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/Fiskid.csv", sep = ";")#fish species names in English and Norwegian
komlist<-read.csv("/Volumes/ftp.imr.no/Administrative/komlist.csv", sep = ";")#list of municipalities names and codes
krabnew <- read_excel("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/krabbefangst_2013_2018.xlsx")
catch2018 <-read_excel("/Volumes/ftp.imr.no/Fishery/DeliveryDataFiskDir/fisk_fangst_2018.xlsx")
```

# Cleaning and formatting fish landings data: cheking species names
```{r, results="hide"}
temp_catch17 <-select(temp_catch17, -c("Artskode","Fangstaar")) %>% rename("Lengdegr"= "Lengdegr.l.l.")
temp_catch99 <-select(temp_catch99, -Artskode) %>% rename("Lengdegr"= "Lengdegr.l.l.")#remove species code, which is different between 1990s and 2000s
temp_catch<-bind_rows(temp_catch99, temp_catch17)
colnames(temp_catch) <- c("Year", "Month", "Municip_number", "Municip_name","Species",
                          "Coast_ocean", "Region", "Fleet_length", "Catch_weight", "Payed_NOK")
#several norwegian names were used for the same species, let's check all variations
fishnames<-unique(temp_catch$Species)
str_view(fishnames, regex("torsk", ignore_case = TRUE))#Annen Torsk, Nordostarktisk torsk, Torsk, Torsk (oppdrett), Polartorsk
str_view(fishnames, regex("hyse", ignore_case = TRUE))#Hyse, Nordostarktisk hyse , Annen hyse
str_view(fishnames, regex("lodde", ignore_case = TRUE))#Lodde,Barentshavslodde, Lodde - Island/O Gronl./Jan M
str_view(fishnames, regex("sei", ignore_case = TRUE))#Sei, Sei (oppdrett)
str_view(fishnames, regex("sild", ignore_case = TRUE))#Sild, Feitsild, Nordsjosild,Norsk vaargytende sild, Skagerraksild, Strom-/Vassild, Stromsild/Vassild
str_view(fishnames, regex("kongekrabbe", ignore_case = TRUE))#Kongekrabbe, han-, Kongekrabbe, hun-, Kongegrabbe
```

# Creating clean catches data: unifying species names and municipalities names.
```{r }
# I assume that we don't need maricultured cod and saithe (oppdrett torsk, oppdrett sild), and capeling from Iceland and Greenalnd, Skagerraksild, Nordsjosild
catch_clean <- temp_catch %>%
  select(-c(7, 10)) %>% # remove columns "Region" and "Payed_NOK", we don't need them for now
  filter(Coast_ocean == "8") %>% # %>% #select only coastal areas
  filter(!Species %in% c(
    "Torsk (oppdrett)", "Polartorsk", "Lodde - Island/O Gronl./Jan M",
    "Sei (oppdrett)", "Skagerraksild", "Strom-/Vassild", "Stromsild/Vassild"
  )) %>%
  filter(Species %in% c(
    "Annen Torsk", "Annen torsk", "Nordostarktisk torsk",
    "Skrei", 
    "Hyse", "Nordostarktisk hyse","Annen hyse", 
    "Sei", 
    "Lodde", "Barentshavslodde",
    "Sild", "Feitsild", "Norsk vaargytende sild", 
    "Kongekrabbe","Kongekrabbe, hun-", "Kongekrabbe, han-"
  )) %>%
  mutate(Species = replace(Species, Species %in% c("Annen Torsk", "Annen torsk", "Nordostarktisk torsk", "Skrei"), "Atlantic cod")) %>%
  mutate(Species = replace(Species, Species %in% c("Nordostarktisk hyse", "Annen hyse", "Hyse"), "Haddock")) %>%
  mutate(Species = replace(Species, Species %in% c("Barentshavslodde", "Lodde"), "Capelin")) %>%
  mutate(Species = replace(Species, Species %in% c("Kongekrabbe, hun-", "Kongekrabbe, han-", "Kongekrabbe"), "Kingcrab")) %>%
  mutate(Species = replace(Species, Species %in% c("Feitsild", "Norsk vaargytende sild", "Sild"), "Atlantic herring")) %>%
  mutate(Species = replace(Species, Species == "Sei", "Saithe")) %>%
  rename("English" = "Species") %>%
  left_join(komlist[, c(1, 2)], c("Municip_number" = "Komnum")) %>%
  select(-4) %>% # remove the first column with municipalities names
  rename("Municip_name" = "Name") %>%
  select(c(1, 2, 3, 8, 4, 7, 6))
  
kable(head(catch_clean, 5)) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)
```

# Final cleaning: inserting missing names of municipalities, aggregating catch data for months and fleet sizes
```{r}
catch_final <- catch_clean %>% 
             mutate(Municip_name = as.character(Municip_name)) %>% 
             mutate(Municip_name = replace(Municip_name, Municip_number == 1839, "Beiarn")) %>% 
             mutate(Municip_name = replace(Municip_name, Municip_number == 1842, "Skjerstad_2005")) %>% 
             mutate(Municip_name = replace(Municip_name, Municip_number == 1901, "Harstad_2013")) %>% 
             mutate(Municip_name = replace(Municip_name, Municip_number == 1915, "Bjarkoy_2013")) %>% 
             mutate(Municip_name = replace(Municip_name, Municip_number == 2011, "Guovdageaidnu-Kautokeino")) %>% 
             group_by(Year,Municip_number,Municip_name,English) %>% 
             summarize(Total_catch = sum(Catch_weight))

#write_csv(catch_final,"data/fish_catch_by_municipality.csv")
```

# Cleaning new crab catch data (2015-2017)
```{r}
#names(krabnew) <-str_replace(names(krabnew), "[:punct:]{2,}", "_")
names(krabnew) <-str_replace(names(krabnew), "-", "_") %>% 
  gsub(" ","",.) %>% 
  gsub("/","",.)

  
krabnew_prep <- krabnew %>%
  mutate(Art_gruppe = trimws(Art_gruppe, "b")) %>%
  mutate(English = replace(Art_gruppe, Art_gruppe %in% c("Kongekrabbe, han", "Kongekrabbe, annen"), "Kingcrab")) %>%
  mutate(Municip_name = str_to_title(gsub("Å", Landingskommune, replacement = "A"))) %>%
  mutate(Municip_name = str_to_title(gsub("ø", Municip_name, replacement = "o"))) %>%
  mutate(Municip_name = str_to_title(gsub("æ", Municip_name, replacement = "ae"))) %>%
  mutate(Catch = gsub(",", MeasureValues, replacement = ".")) %>%
  left_join(komlist[, c(1, 2)], by = c("Municip_name" = "Name")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Deatnu-Tana", "Tana")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Unjargga-Nesseby", "Nesseby")) %>%
  rename(Municip_number = Komnum, Year = Fangstår) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Nesseby", 2027)) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Tana", 2025)) %>%
  mutate(Catch = as.numeric(Catch)) %>% 
  select(-c(
    "Art_gruppe", "Landingsfylke_kommune",
    "Landingskommune",
    "Lengdegruppe",
    "MeasureNames", "Redskap_hovedgruppe",
    "MeasureValues"
  )) %>% 
  select(Year,Municip_number,Municip_name, English, Catch)

```
```{r}
krabnew_final <- krabnew_prep %>% 
   group_by(Year,Municip_number,Municip_name,English) %>% 
             summarize(Total_catch = sum(Catch)) 
  
```

# Cleaning fish catch 2018 data
Similar to new crab data cleaning steps.
```{r}
catch2018_prep <- catch2018[-1,] 
names(catch2018_prep) <- catch2018[1,]

names(catch2018_prep) <-str_replace(names(krabnew), "-", "_") %>% 
  gsub(" ","",.) %>% 
  gsub("/","",.)

#Check if names of fishes were writen differently
str_view(catch2018_prep$Art_gruppe, regex("torsk", ignore_case = TRUE))#Torsk
str_view(catch2018_prep$Art_gruppe, regex("sild", ignore_case = TRUE))#Sild, norsk vårgytende
str_view(catch2018_prep$Art_gruppe, regex("hyse", ignore_case = TRUE))# Hyse
str_view(catch2018_prep$Art_gruppe, regex("sei", ignore_case = TRUE))#Sei
str_view(catch2018_prep$Art_gruppe, regex("lodde", ignore_case = TRUE))#Lodde
```

```{r}

catch2018_prep2 <-catch2018_prep %>% 
  mutate(Art_gruppe = trimws(Art_gruppe, "b")) %>%
  filter(!grepl("krabbe",Art_gruppe)) %>% 
  mutate(Municip_name = str_to_title(gsub("Å", Landingskommune, replacement = "A"))) %>%
  mutate(Municip_name = str_to_title(gsub("ø", Municip_name, replacement = "o", ignore.case = TRUE))) %>%
  mutate(Municip_name = str_to_title(gsub("æ", Municip_name, replacement = "ae"))) %>%
  left_join(komlist[, c(1, 2)], by = c("Municip_name" = "Name")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Deatnu-Tana", "Tana")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Unjargga-Nesseby", "Nesseby")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Gaivuotna-Kafjord", "Kafjord")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Bo I Nordland", "Bo")) %>%
  mutate(Municip_name = replace(Municip_name, Municip_name == "Heroy I Nordland", "Heroy")) %>%
  rename(Municip_number = Komnum, Year = Fangstår, Catch = MeasureValues, English = Art_gruppe) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Nesseby", 2027)) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Tana", 2025)) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Kafjord",1940 )) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Heroy",1818 )) %>%
  mutate(Municip_number = replace(Municip_number, Municip_name == "Bo", 1867)) %>%
  mutate(Catch = as.numeric(Catch)) %>% 
  mutate(English = replace(English, English %in% c("Sild, norsk vårgytende", "Sild, annen"), "Atlantic herring")) %>% 
  mutate(English = replace(English, English == "Torsk", "Atlantic cod")) %>% 
  mutate(English = replace(English, English == "Hyse", "Haddock")) %>% 
  mutate(English = replace(English, English == "Lodde", "Capelin")) %>% 
  mutate(English = replace(English, English == "Sei", "Saithe")) %>% 
  select(Year,Municip_number,Municip_name, English, Catch) 
```

```{r}
catch2018_final <- catch2018_prep2 %>% 
     mutate(Year = as.integer(Year)) %>% 
     group_by(Year,Municip_number,Municip_name,English) %>% 
     summarize(Total_catch = sum(Catch)) 
```

# Mering old and new catch data
```{r}
catch_merged <- bind_rows(catch_final, catch2018_final, krabnew_final)
#write_csv(catch_merged,"data/fish_catch_by_municipality_update2018.csv")
```

