---
title: "Escapees data preparation"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---

# Loading libraries
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE)
library(readr)
library(readxl)
library(janitor)
library(dplyr)
library(stringr)
library(qdap)
```

# Loading data tables
```{r}
#escap_raw <-read_excel("raw/Escapees.xlsx")# - reading from raw 
#reading data from ftp at IMR
escap_raw <-read_excel("/Volumes/ftp.imr.no/Aquaculture/Escapees/Escapees.xlsx")#mac path

escap_prep <-escap_raw[-c(1:2),]

colnames(escap_prep) <-c("county", "company", "location_number","species", "size_kg", "date", "year", "count_escaped", "count_esc_fishdir", "produced", "recatched", "escaped_final")
escap_prep <- filter(escap_prep, !county %in% c("M","H","NT","ST","SF","R","AA"))


lusedata<-read.csv(file = "raw/lakselus_per_fisk_utf8.csv", fileEncoding = "UTF-8") 
#lusedata <-read.sv("/Volumes/ftp.imr.no/Aquaculture/Lice/Lusedata.xlsx") - use this path after the file is on ftp
lusedat_prep <- clean_names(lusedata)

#list of municipalities names and numbers
komlist<- read.csv("../../administrative/komlist.csv", sep = ";")
```

# Formatting acquaculture registry data 
My idea was to use aquaculture registry to get the geogprahical locaiton of all the companies in the escapees data.
However, when I tired to match aquaculture registry with escapees data by location numbers, I got 43 mismatches (locaitons, not occuring in aquaculture registry).
All these locaitons have escapees data for 2006 - 2015. So, I assume that those are companies that shut down or were sold to other companies, or have moved to other locaitons.
Escapees data has one observation per year, lice - weekly observations.

# Merge escapees data lice data 
Heglelandtorsk appeared as <span style="color:blue">Helgelandtorsk</span> and as <span style="color:blue">Helgelandtorsk AS</span>, i will make them similar because different names for this company creates problems. 
Identified duplicates after merging escapees with municipalities in lice data: <span style="colour:blue">Håløy Havservice AS</span> (municipality must be 1903), 
and <span style="color:blue">Nordlaks Oppdrett AS</span> (municipality must be 1903 - Harstad). In both cases duplicates were due to Harstad merged with Bjarkoy in 2013. 
One of the <span style="color:blue">Jøkelfjord Laks AS</span> data rows does not havel location and municipality, I will assume they are the same as in another data row (loc 10808 and municip 1943 ) 
```{r}
lusedat_prep2 <- lusedat_prep %>% 
   mutate(location_number = as.character(lokalitetsnummer)) %>% 
   group_by(location_number,kommunenummer) %>% summarize(total = n()) %>% 
   filter(!is.na(kommunenummer))
   
escap_clean <- escap_prep %>% 
     left_join(lusedat_prep2[,-3], by = "location_number") %>% 
     mutate(company = replace(company, company == "Helgelandstorsk", "Helgelandstorsk AS")) %>% 
     filter(!(company == "Håløy Havservice AS" & kommunenummer == "1901")) %>% 
     filter(!(company == "Nordlaks Oppdrett AS" & kommunenummer == "1915")) %>% 
     mutate(location_number = replace(location_number, company == "Jøkelfjord Laks AS", "10808")) %>% 
     mutate(kommunenummer = replace(kommunenummer, company == "Jøkelfjord Laks AS", "1943")) 
```

##  Exploring missing data: which companies did not have municipality number after merging escapees and lice data?
```{r}
nas <- filter(escap_clean, is.na(kommunenummer)) %>% 
      group_by(county, company, location_number) %>% 
      summarize(n = n()) #31 companies did not have info on locaiton, I get info by  google serach.
#write.csv(nas, "missing_companies.csv")
```

##  Loading back the missing companies data
```{r}
missing <-data.table::fread("./data/missing_companies.csv",select = c(2,3,5), encoding = "UTF-8")
```

## Getting municipalities numbers for companies with no municipality location registered
I remove  <span style="color:blue">Hammerfest Lakseslakteri</span> and  <span style="color:blue">Victoria Lady (brønnbåt)</span> and because they don't have location numbers. 
```{r}
missing_prep <-left_join(missing, komlist[,c(1,2)], by = c("municip" = "Name")) %>% 
                mutate(location_number = as.character(location_number)) %>% 
                mutate(company = as.character(company)) %>% 
                filter(!company %in% c("Victoria Lady (brønnbåt)","Hammerfest Lakseslakteri")) 
              
          
missing_final <-filter(escap_clean, is.na(kommunenummer)) %>% 
     group_by(company, location_number) %>% 
     left_join(missing_prep, by = c("company", "location_number")) %>% 
     ungroup() %>% 
     mutate(kommunenummer = Komnum) %>% 
     mutate(kommunenummer = as.character(kommunenummer)) %>% 
     select(-c(municip, Komnum))
```

Mergin did not work for <span style="color:blue">Sjøfisk AS</span> and <span style="color:blue">Sjølaks AS</span>,I suspect due to special character ø which dplyr sometimes does not recognize
```{r}
komlist <-mutate(komlist, Komnum = as.character(Komnum))

escap_fin <-bind_rows(filter(escap_clean, !is.na(kommunenummer)), 
                             missing_final) %>% 
          mutate(kommunenummer = replace(kommunenummer, company == "Sjølaks AS", "1943")) %>% 
          mutate(kommunenummer = replace(kommunenummer, company == "Sjøfisk AS", "1903")) %>% 
          left_join(komlist[,c(1,2)], by = c("kommunenummer"  = "Komnum")) %>% 
          rename("kommunenavn" = "Name")

#I delete Victoria Lady (brønnbåt) altogether as it does not have municipality
#I add Hammerfest municipality to the row of Hammerfest Lakseslakteri, but locaiton number for this companu is unknown.
escap_fin <-escap_fin %>% 
          mutate(kommunenummer = replace(kommunenummer, company == "Hammerfest Lakseslakteri", "1903")) %>% 
          mutate(kommunenavn = replace(kommunenavn, company == "Hammerfest Lakseslakteri", "Hammerfest")) %>% 
          filter(!company == "Victoria Lady (brønnbåt)")
```

## How many locations per municipality for each year and each species and what is the range of escapees count?
```{r}
#Most of the municipalities had just one ovservation from a single locaiton each year. 
#Some observations for salmon and cod have from differnet locations within the same municipality and year, but no more than 4. 
#Number of escapees within same municipality may vary considerabely, thus we should not average them.

escap_range <-escap_fin  %>% 
             group_by(year, kommunenummer, species) %>% 
             summarize(locperyear = n(),min_esap = min(escaped_final), max_escap = max(escaped_final)) 
           
```

# Aggreagte escapees counts per municiaplity per year per species
```{r}
escap_spp <-escap_fin  %>% 
             mutate_at(c(8:12), as.numeric) %>% 
             group_by(year, kommunenummer, species) %>% 
             summarize(count_escaped = sum(count_escaped),count_esc_fishdir = sum(count_esc_fishdir), 
                       produced = sum(produced), recathced = sum(recatched), escaped_final = sum(escaped_final)
                       )
write_csv(escap_spp,"./data/escapees_per_yrmpspp.csv")
```
