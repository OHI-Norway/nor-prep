---
title: "Estimating aquaculture sustainability socres"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---

```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```


```{r include = FALSE}
library(zoo)
```

# Loading data sets
```{r libraries, results="hide"}
totprod <-read.csv("data/total_mariculture_production.csv")

protein <-read.csv("data/protein_efficiency_ratio.csv")
# protein <-protein %>% 
#   mutate(per = replace(protein_new, is.na(protein_new), 0 ))

lice <-read.csv("data/locs_above_licethr_yearly_averages.csv")
lice <-select(lice,-1)

momb <-read.csv("data/mean_momb_mp_yr.csv")
momb <-momb %>% select(-1) 
```

# Calculating sustainability index of aquaculture
```{r}

gm_mean <- function(...) {
  x <- c(...)
  if (all(is.na(x))) {
    return(NA)
  } else {
    prod(x, na.rm = TRUE)^(1 / sum(!is.na(x)))
  }
}

sustainability <- protein %>%
  full_join(lice, by = c("yrs" = "Year", "kname" = "Municip_name", "knr2017" = "Municip_number")) %>%
  full_join(momb, by = c("yrs" = "Year", "kname" = "Kommune", "knr2017" = "Komnum")) %>%
  mutate(lice_stats = (1 - average_prop_locs_above_thr)) %>%
  select(-c(average_locs_above_thr, average_prop_locs_above_thr)) %>%
  rowwise() %>%
  mutate(sustainability = gm_mean(protein_new, lice_stats, momb_mean)) %>% 
  filter(yrs >= 2005 & yrs <= 2014)

```

BUT WITH MANY NA, SUSTAINABILITY IS OFTEN BASED ONLY ON PROTEIN EFFICIENCY!! DELETE THOSE ROWS?
# Merging total production and sustainability
```{r}
sustain_prod <- totprod %>%
  full_join(sustainability[, c(1, 2, 3, 11)], by = c("yrs", "knr2017", "kname")) %>%
  select(-c(
    "trout_prod_kg",
    "salmo_prod_kg",
    "avg_bm_trout_kg",
    "avg_bm_salmo_kg",
    "dbm_trout_kg",
    "dbm_salmo_kg",
    "total_production",
    "total_prod_corrected"
  ))
```

# Applying 3-year rolling mean on the total aquaculture production 
```{r}
municipalities <-unique(totprod$kname)

finallist <-list()

for (i in 1:length(municipalities)) 
  {
   mp <- municipalities[i]
   df.mp <- totprod %>% 
      filter(kname == mp)
      runmean <-data.frame(prod_runmean = rollapply(df.mp$total_prod_corrected, width = 3, FUN = mean,  fill=NA))
      df.mp.full <- bind_cols(df.mp, runmean)
      finallist[[i]] <- df.mp.full
 }
 
smoothed_prod <- do.call("rbind", finallist)
map(smoothed_prod, ~ sum(is.na(.x)))#lost 162 observations due to 3-years running mean
mosaic::fav_stats(smoothed_prod$prod_runmean)
```

# Check the distribution of the smoothed total production
```{r}
smprod_plot <- ggplot(data = smoothed_prod) +
  geom_density(
    mapping = aes(x = prod_runmean),
    fill = "coral", color = "darkred", alpha = 0.7
  ) +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Total aquaculture production, kg") +
  theme(axis.text = element_text(size = 12)) +
  theme_gdocs()

smprod_plot
```



# Multiplying smoothed produciton by sustainability index
```{r}
sustain_prod <- smoothed_prod %>%
  left_join(sustainability[, c(1, 2, 3, 11)], by = c("yrs", "knr2017", "kname")) %>%
  rowwise() %>%
  mutate(sust_prod = prod(prod_runmean, sustainability, na.rm = F)) %>%
  select(-c(
    "trout_prod_kg",
    "salmo_prod_kg",
    "avg_bm_trout_kg",
    "avg_bm_salmo_kg",
    "dbm_trout_kg",
    "dbm_salmo_kg",
    "total_production",
    "total_prod_corrected"
  ))
```

# Estimate growth rate based on smoothed produciton and growth rate score
growth rate score is growth rate divided by 1.01 in our case, set to 1 when the growth is greater than 1.
```{r}

```


# Estimating final aquaculture score
Mulitply growth rate score by the smoothed sustainability and multiply by 100
```{r}
foo <- data.frame(yrs = sustain_prod$yrs, 
                  kname = sustain_prod$kname, 
                  knr2017 = sustain_prod$knr2017, 
                  sust_prod = sustain_prod$sust_prod)
foolag <- foo %>%  mutate(lagged_prod = lag(sust_prod, 1))

akva_score_final <-sustain_prod %>% 
  left_join(foolag[,-4], by = c("yrs", "knr2017", "kname")) %>% 
  mutate(growth = sust_prod/lagged_prod) %>% 
  mutate(score = case_when(growth >= 1.01 ~ 1,
         growth < 1.01 ~ growth
  ))
```


DO THESE EARLIER,WHEN YOU CREATE A TABLE OF SUSTIANBILITY AND PRODUCITON 



