---
title: "Total aquaculture production"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r libraries, results="hide"}
library(ggthemes)
library(janitor)
library(DT)
```

# Loading aquaculture produciton data: total biomass produced, feed used, and biomass change per month.
```{r}
biomass <-read.csv(file.path(dir_M[2],"Aquaculture/Production/Production_data_unlocked/akva_biomass_2005_2016_preformatted.csv")) 
feed <-read.csv(file.path(dir_M[2],"Aquaculture/Production/Production_data_unlocked/akva_feed_2005_2016_preformatted.csv")) 
uttak <-read.csv(file.path(dir_M[2],"Aquaculture/Production/Production_data_unlocked/akva_uttak_2005_2016_preformatted.csv")) 
municip <- read.table("../../administrative/komlist.csv", header = TRUE, sep = ";")
```

# Cleaning and formatting the data
## Pre-clean standing biomass table
```{r}
biomass_prep <- biomass %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  mutate(biomchange_salmon = (laks_des_beh_kg-laks_jan_beh_kg)) %>% 
  mutate(biomchange_trout = (regnb_des_beh_kg-regnb_jan_beh_kg)) %>% 
  select(c(year,kommunenr,kommune,biomchange_salmon, biomchange_trout)) %>% 
  left_join(municip[,c(1,2)], by = c("kommunenr"="Komnum")) %>% 
  mutate(kommune = Name) %>% 
  select(-Name) %>% 
  filter(!is.na(kommune))
```
Grane kommune is in aquaculture table but not in the komlist. I assume we do not inlcude Grane kommune in the project.
Anyway Grane has aquaculture only in 2006 and 2007. 

Which municipalities did not have aquaculture?
```{r}
anti_join(municip, biomass[,c(4,5)], municip, by = c("Komnum"="KOMMUNENR")) %>% 
  arrange(Name) %>% 
  filter(Name != "NonCoast") %>% 
  datatable()
```

## Pre-clean uttak (executed fish) table
```{r}
uttak_prep <- uttak %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  select(-c(fylkesnr, fylke, kommune)) 
```

## Pre-clean feed table
```{r}
feed_prep <- feed %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  select(-c(fylkesnr, fylke, kommune)) 
```

# Merging the three tables
```{r}
production_prep <- biomass_prep %>% 
  full_join(uttak_prep, feed_prep, by = c("year", "kommunenr")) %>% 
  filter(kommunenr != 1825) #remove Grane municipality
```

How many years of data per municipality?
In 50 observations, there were data for biomass change but no data for executed fish.
```{r}
production_prep %>%  
  group_by(kommunenr) %>% 
  summarize(nyears = n()) %>% 
  datatable()
```

 FISKEDIR commented that no record of uttak (executed fish) in a given year, is likely zero uttak.
 Thus, I will replace NA of uttak with 0. 
```{r}
production_prep2 <-production_prep %>% 
  mutate_at(c("uttak_laks_kg", "uttak_regnb_kg"), ~ ifelse(is.na(.), 0, .))
```

NOW, add utkast data from FISKEDIR.
Add data on years 2017-2018.


# Check the overall distribution of aquaculture production
```{r}

mosaic::fav_stats(akva_final$total_prod_corrected)
# min Q1  median      Q3      max    mean      sd   n missing
#    0  0 3041960 6843759 24784477 4427182 4763020 810       0

densplot_data <- akva_final %>%
  mutate(total_prod_corrected = as.numeric(total_prod_corrected))

dens_plot <- ggplot(data = densplot_data) +
  geom_density(
    mapping = aes(x = total_prod_corrected),
    fill = "salmon", color = "darkred", alpha = 0.7
  ) +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Total aquaculture production, kg") +
  theme(axis.text = element_text(size = 12)) +
  theme_gdocs()

dens_plot
```


## Creating ggplot theme
```{r}
theme_map <- function(...) {
  theme_stata(scheme = "s1color") +
    theme(
      legend.position = "none",
      axis.text.x = element_text(
        size = 6, angle = 90, hjust = 1, vjust = 0.5,
        face = "bold"
      ),
      axis.text.y = element_text(size = 7, angle = 0),
      axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
      plot.title = element_text(hjust = 0.5, vjust = 0.5),
      axis.ticks.x = element_line(size = 0.5),
      axis.ticks.length = unit(0.2, "cm"),
      strip.text = element_text(size = 12)
    )
}
```


## Plotting total acquaculture production 
```{r}
county_names <- list("Finnmark", "Nordland", "Troms")

counties_df <- split(akva_final, akva_final$county)

plots_akva <- map2(
  counties_df, 
  names(counties_df),
   ~ ggplot(data = .x, mapping = aes(x = as.numeric(yrs), y = as.numeric(total_prod_corrected))) +
  geom_col(fill = "dodgerblue4") +
  ggtitle(.y)  +
  facet_wrap(kname ~ .) +
  scale_x_continuous(breaks = breaks1, labels = labels1) +
  scale_y_continuous(trans = "log10") +
  labs(y = "Log(Total Mariculture prod (tons))", x = "") +
  theme_map())

 file_names <- paste0("figs/tot_prod", "_", county_names, ".pdf")
 map2(file_names, plots_akva, ggsave)

```

 
 
 
