---
title: "Total aquaculture production"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r libraries, results="hide"}
library(ggthemes)
library(janitor)
library(DT)
```

# Loading aquaculture produciton data: total biomass produced, feed used, and biomass change per month.
```{r}
biomass_0518 <-read.csv(file.path(dir_M[2],"Aquaculture/Production/production_unlocked_concatenated_2005_2018/akva_biomass_2005_2018_formatted.csv")) 
feed_0518 <-read.csv(file.path(dir_M[2],"Aquaculture/Production/production_unlocked_concatenated_2005_2018/akva_feed_2005_2018_formatted.csv")) 
tap_0518 <-read.csv(file.path(dir_M[2],"Aquaculture/Production/production_unlocked_concatenated_2005_2018/akva_tap_formatted_2005_2018.csv"))
uttak_0518 <-read.csv(file.path(dir_M[2],"Aquaculture/Production/production_unlocked_concatenated_2005_2018/akva_uttak_2005_2018_formatted.csv")) 
"/Volumes/ftp.imr.no/Aquaculture/Production/production_unlocked_concatenated_2005_2018/akva_biomass_2005_2018_formatted.csv"
municip <- read.table("../../administrative/komlist.csv", header = TRUE, sep = ";")
```

# Cleaning and formatting the data
## Pre-clean standing biomass table
```{r}
biomass_prep <- biomass_0518 %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  mutate(biomchange_salmon = (laks_des_beh_kg-laks_jan_beh_kg)) %>% 
  mutate(biomchange_trout = (regnb_des_beh_kg-regnb_jan_beh_kg)) %>% 
  select(c(year,kommunenr,kommune,biomchange_salmon, biomchange_trout)) %>% 
  left_join(municip[,c(1,2)], by = c("kommunenr"="Komnum")) %>% 
  mutate(kommune = Name) %>% 
  select(-Name) %>% 
  filter(!is.na(kommune)) #Delete rows with Grane municipality (number of municipality 1825)
```
Grane municipality is in aquaculture table but not in the komlist. I assume we do not inlcude Grane kommune in the project.
Anyway Grane has aquaculture only in 2006 and 2007. 

## Check how fish biomass was changing over a year
```{r}
biom_change0506 <- data.frame(
  year = rep(c(2005, 2006), each = 12),
  month = rep(c(1:12), 2),
  salmon = c(
    unname(unlist(biomass_0518[1, c(6:17)])),
    unname(unlist(biomass_0518[61, c(6:17)]))
  )
)
                             

ggplot(data = biom_change0506) +
  geom_line(aes(x = as.factor(month), y = salmon, color = as.factor(year), group = year), size = 2) +
  labs(x = "Month",
       y = "Biomass, kg") +
  scale_color_manual(values = c("darkolivegreen", "darkorchid"), name = "Year") +
      theme_minimal() +
  theme(
    axis.text = element_text(size = 10),
    legend.text = element_text(size = 10)
  ) +
  annotate("text", x = 4, y = 1000000, label = "Uttak", color = "orchid", face = "bold") +
  annotate("text", x = 11, y = 1800000, label = "Uttak", color = "darkolivegreen4", face = "bold")
```

Which municipalities did not have aquaculture?
```{r}
anti_join(municip, biomass_0518[,c(4,5)], municip, by = c("Komnum"="KOMMUNENR")) %>% 
  arrange(Name) %>% 
  filter(Name != "NonCoast") %>% 
  datatable()
```

## Pre-clean uttak (executed fish) table 
```{r}
uttak_prep <- uttak_0518 %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  select(-c(fylkesnr, fylke, kommune)) 
```

## Pre-clean tap (lost fish) table and convert to kg
```{r}
utkast_prep <- tap_0518 %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  select(-c(fylkesnr, fylke, kommune,tap_d_dfisk, tap_r_mming, tap_annet)) %>% 
  mutate(lost_final_kg = tap_utkast*6)
```


## Pre-clean feed table
```{r}
feed_prep <- feed_0518 %>% 
  clean_names() %>% 
  rename(year = aar) %>% 
  select(-c(fylkesnr, fylke, kommune)) 
```

# Merging the three tables

FISKEDIR commented that no record of uttak (executed fish) in a given year, is likely zero uttak.
 Thus, I will replace NA of uttak with 0.
 Similarly,I will assume that no observation of lost fish means zero fish was lost (fish thrown away during slaughtering).
 When the biomass has decreased over a year, I set biomass change to zero.
```{r}
production_prep <- biomass_prep %>%
  left_join(feed_prep, by = c("year", "kommunenr")) %>%
  left_join(uttak_prep, by = c("year", "kommunenr")) %>%
  left_join(utkast_prep, by = c("year", "kommunenr")) %>%
  filter(kommunenr != 1825) %>% # remove Grane municipality
  select(-tap_utkast) %>%
  mutate_at(c("uttak_laks_kg", "uttak_regnb_kg", "lost_final_kg"), ~ ifelse(is.na(.), 0, .)) %>%
  mutate(biomchange_salmon = ifelse(biomchange_salmon < 0, 0, biomchange_salmon)) %>%
  mutate(biomchange_trout = ifelse(biomchange_trout < 0, 0, biomchange_trout)) %>%
  rowwise() %>% 
  mutate(production_final = sum(biomchange_salmon, uttak_laks_kg, biomchange_trout, uttak_regnb_kg, -lost_final_kg))
```

How many years of data per municipality?
In 50 observations, there were data for biomass change but no data for executed fish.
```{r}
production_prep %>%  
  group_by(kommunenr) %>% 
  summarize(nyears = n()) %>% 
  datatable()
```


# Estimate economic feed conversion ratio (eFCR)
I found out that in two occasions (Gratangen 2008 and Berg 2009), the amount of fish thrown away was larger than the amount of produced fish. 
This is strange, but I will just assume that the production is zero. Apparently, there was an underestimation of the number of fish in the cages. 
Also in two occasions (Sor-Varanger 2005 and Evenes 2016) there was no amount of feed registered although there was production. I set efcr to NA in these cases.

```{r}
estimate_efcr <- function(feed, biom){
  if(all(c(feed, biom) > 0)) {
    consump = feed/biom 
  } else if (feed == 0) {
    consump = NA
  } else {
    consump = 0
  }
  consump
}  
```

```{r}
akva_final <- production_prep %>% 
  rename(feed_used_kg = f_rforbruk_kg) %>% 
  mutate(production_final = ifelse(production_final < 0, 0, production_final)) %>% 
  rowwise() %>% 
  mutate(efcr = estimate_efcr(feed_used_kg,production_final)) %>% 
  mutate(county = case_when(
    kommunenr >= 1800 & kommunenr< 1900 ~ "Nordland",
    kommunenr >= 1900 & kommunenr< 2000 ~ "Troms",
    kommunenr >= 2000 ~ "Finnmark"
    
  ))
```


# Check the overall distribution of aquaculture production
```{r}
mosaic::fav_stats(akva_final$production_final)
```

```{r}
dens_plot <- ggplot(data = akva_final) +
  geom_density(
    mapping = aes(x = production_final),
    fill = "salmon", color = "darkred", alpha = 0.7
  ) +
  ggtitle("Distribution of the total aquaculture production") +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Total aquaculture production, kg") +
  theme(axis.text = element_text(size = 12)) +
  theme_gdocs()

dens_plot
```

# How did total production vary in the whole region annually?
```{r fig.width=8}

ggplot(akva_final, aes(x = reorder(as.factor(year), production_final, FUN=sum), y = production_final)) +
  geom_boxplot() +
  geom_jitter(aes(color = county), alpha = 0.5, size = 2,
              position = position_jitter(width = 0.3, height = 0)) +
  labs(x = "", y = "Production, kg") +
  theme_gdocs() +
  scale_color_manual(values = c("#ed48ff", "#486dff", "#ffc848"))

```

# How did eFCR vary in the whole region annually?
```{r fig.width=10}
ggplot(akva_final) +
  facet_wrap(. ~ county) +
  geom_point(aes(x = year, y = efcr, color = county), alpha = 0.5, size = 3) +
  labs(x = "", y = "eFCR") +
  geom_smooth(aes(x = year, y = efcr, color = county, fill = county), ) +
  theme_minimal() +
  scale_y_continuous(limits = c(0,5)) +
  scale_x_continuous(breaks = seq(2004,2018, by =2)) +
  scale_color_manual(values = c("#ed48ff", "#486dff", "#ffc848"), name = "County") +
  scale_fill_manual(values = c("#ed48ff", "#486dff", "#ffc848"), name = "County") +
  theme(
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10, face = "bold")
  )
```


## Creating ggplot theme
```{r}
theme_akva <- function(...) {
  theme_stata(scheme = "s1color") +
    theme(
      legend.position = "none",
      axis.text.x = element_text(
        size = 6, angle = 90, hjust = 1, vjust = 0.5,
        face = "bold"
      ),
      axis.text.y = element_text(size = 7, angle = 0),
      axis.title.y = element_text(margin = margin(t = 0, r = 10, b = 0, l = 0)),
      plot.title = element_text(hjust = 0.5, vjust = 0.5),
      axis.ticks.x = element_line(size = 0.5),
      axis.ticks.length = unit(0.2, "cm"),
      strip.text = element_text(size = 12)
    )
}
```


## Plotting total acquaculture production 
```{r}

breaks1 <- seq(1994, 2018, by = 1)
labels1 <- as.character(breaks1)
labels1[!breaks1%%2==0]<- ""


county_names <- list("Finnmark", "Nordland", "Troms")

counties_df <- split(akva_final, akva_final$county)

plots_akva <- map2(
  counties_df, 
  names(counties_df),
   ~ ggplot(data = .x, mapping = aes(x = as.numeric(year), y = as.numeric(production_final))) +
  geom_col(fill = "dodgerblue4") +
  ggtitle(.y)  +
  facet_wrap(kommune ~ .) +
  scale_x_continuous(breaks = breaks1, labels = labels1) +
  scale_y_continuous(trans = "log10") +
  labs(y = "Log(Total Mariculture prod (tons))", x = "") +
  theme_akva())

 file_names <- paste0("figs/tot_akva_prod", "_", county_names, ".pdf")
 map2(file_names, plots_akva, ggsave)

```

 
 
 
