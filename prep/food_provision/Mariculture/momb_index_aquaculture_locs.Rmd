---
title: "Mom-b examination of aquaculture localities"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r libraries, results="hide"}
library(ggthemes)
library(janitor)
```

# Load mom-b examination data and municipalities names
NB!I use only the dataset send by Fishereis directorate on July 2nd, 2019.
```{r}
load_by_sheet <-function(x, page = 1) {
  read_excel(file.path(x),sheet = page)
}
path <-file.path(dir_M[2],"Aquaculture/MOMB_2019/B-undersÃ¸kelser Nordland_Troms_Finnmark _Fdir_june2019nr.xls")
page <- list(5,6,7)
allcounties <- map2(path, page, load_by_sheet) 

momb_prep <-  allcounties %>% 
  do.call("rbind", .) %>% 
  clean_names()
```

```{r}
akvareg <-load_by_sheet(path, page = 4) 
akvareg <- akvareg %>%  mutate(LOK_NR = as.numeric(LOK_NR))
komlist <-read.csv("../../administrative/komlist.csv", sep = ";")
```

# Further preparation of momb data
```{r}
momb_prep2 <-  momb_prep %>% 
  mutate(Year = lubridate::year(dato_provetaking)) %>% 
  select(-c("mom_type", "reference")) %>% 
  rename("Kommune" = "akvareg_lok_kom", "Komnum" = "akvareg_lok_komnr") %>% 
  left_join(komlist[,c(1,2)], by = "Komnum") %>% 
  mutate(Kommune = Name) %>% 
  select(-Name)
  

map(momb_prep2, ~sum(is.na(.x))) #Still 93 locations did not have info on the municipality where they are located.

momb_prep3 <- momb_prep2 %>% 
  filter(!is.na(Kommune)) 
```
Regarding localities with no municipality info: they are either shut down or have not yet given licence to start the produciton (commented by Fisheries Directorate). Thus, I delete these locaitons. 

## Check how many examined aquaculture localities per municipality each year
```{r}
examinations_year <- momb_prep3 %>% 
  group_by(Year, Kommune) %>% 
  summarize(examinations = n_distinct(loknr))
```

# Preparing final  table: proportion and count of localities with mom b below 2 per municipality
Proportion of localities below mom b 2 in relation to all localities categorized by mom b that year in a municipality.
```{r}
momb_final <- momb_prep3 %>%
  mutate(newindex = case_when(
    momb_index > 2 ~ "1",
    momb_index <= 2 ~ "0"
  )) %>%
  mutate(newindex = as.numeric(newindex)) %>%
  group_by(Year, kommunenr) %>%
  summarize(
    tot_locs = n(),
    locs_momb_low_count = sum(newindex, na.rm = TRUE),
    locs_momb_low_prop = locs_momb_low_count / tot_locs
  )

```



