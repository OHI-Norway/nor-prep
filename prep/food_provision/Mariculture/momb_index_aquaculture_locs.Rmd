---
title: "Mom-b examination of aquaculture localities"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r libraries, results="hide"}
library(ggthemes)
library(janitor)
```

# Load mom-b examination data and municipalities names
NB!I use only the dataset send by Fishereis directorate on July 2nd, 2019.
```{r}
load_by_sheet <-function(x, page = 1) {
  read_excel(file.path(x),sheet = page)
}
path <-file.path(dir_M[2],"Aquaculture/MOMB_2019/B-undersøkelser Nordland_Troms_Finnmark _Fdir_june2019nr.xls")
page <- list(5,6,7)
allcounties <- map2(path, page, load_by_sheet) 

momb_prep <-  allcounties %>% 
  do.call("rbind", .) %>% 
  clean_names()
```

```{r}
akvareg <-load_by_sheet(path, page = 4) 
akvareg <- akvareg %>%  mutate(LOK_NR = as.numeric(LOK_NR))
licenses <-read.csv("data/aquaculture_lisences_northnorway_2010_2018.csv")
komlist <-read.csv("../../administrative/komlist.csv", sep = ";")
```

# Further preparation of momb data
```{r}
momb_prep2 <-  momb_prep %>% 
  mutate(Year = lubridate::year(dato_provetaking)) %>% 
  select(-c("mom_type", "reference")) %>% 
  rename("Kommune" = "akvareg_lok_kom", "Komnum" = "akvareg_lok_komnr") %>% 
  left_join(komlist[,c(1,2)], by = "Komnum") %>% 
  mutate(Kommune = Name) %>% 
  select(-Name)
  

map(momb_prep2, ~sum(is.na(.x))) #Still 93 locations did not have info on the municipality where they are located.

momb_prep3 <- momb_prep2 %>% 
  filter(!is.na(Kommune)) 
```
Regarding localities with no municipality info: they are either shut down or have not yet given licence to start the produciton (commented by Fisheries Directorate). Thus, I delete these locaitons. 

## Check how many examined aquaculture localities per municipality each year and compare to total
```{r}
names(licenses) <- gsub("Ø", names(licenses), replacement = "O") %>%
  gsub("Å", ., replacement = "A") %>%
  str_to_lower(.)

totlocs_mp <- licenses %>%
  filter(vannmiljo == "SALTVANN") %>%
  group_by(year, till_komnr, till_kom) %>%
  summarize(nlocs = n_distinct(lok_nr)) %>% 
  rename(Year = year, Komnum = till_komnr,Kommune = till_kom)

#Examinations per year per municipality
examinations_year <- momb_prep3 %>% 
  group_by(Year, Kommune, Komnum) %>% 
  summarize(examinations = n_distinct(loknr)) %>% 
  left_join(totlocs_mp, by = c("Year", "Komnum"))

#Compare the number of examinations to the total number of registered localities
examinations_filtered <- filter(examinations_year, !is.na(nlocs))
examinations <-examinations_filtered$examinations
totals <-examinations_filtered$nlocs

for (i in length(examinations)) {
 print(examinations[examinations == totals])
  }
```

# Preparing final  table: average momb per municipality and year
```{r}
momb_prep4 <- momb_prep3 %>%
  mutate(mombtrans = case_when(
    miljo_tilstand == 1 ~ "1",
    miljo_tilstand == 2 ~ "0.66",
    miljo_tilstand == 3 ~ "0.33",
    miljo_tilstand == 4 ~ "0"
  )) %>%
  mutate(mombtrans = as.numeric(mombtrans)) %>%
  group_by(Year, Komnum, Kommune) %>%
  summarize(momb_mean = mean(mombtrans))

write.csv2(momb_prep4, "data/mean_momb_mp_yr.csv")
```



