---
title: "Mom-b examination of aquaculture localities"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    css: '~/github/nor-prep/prep/templates/style.css'
    toc: true
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/nor-prep/prep/templates/norway_banner.html'
  pdf_document:
    toc: true
---
```{r message=FALSE, warning=FALSE}
knitr::opts_chunk$set(message = FALSE, warning= FALSE, message = FALSE)
source('~/github/nor-prep/prep/src/common.R')
```

```{r libraries, results="hide"}
library(ggthemes)
library(janitor)
```

# Load mom-b examination data and municipalities names
NB!I use only the dataset send by Fishereis directorate on July 2nd, 2019.
```{r}
load_by_sheet <-function(x, page = 1) {
  read_excel(file.path(x),sheet = page)
}
path <-file.path(dir_M[2],"Aquaculture/MOMB_2019/B-undersøkelser Nordland_Troms_Finnmark _Fdir_june2019nr.xls")
page <- list(5,6,7)
allcounties <- map2(path, page, load_by_sheet) 

momb_prep <-  allcounties %>% 
  do.call("rbind", .) %>% 
  clean_names()
```

```{r}
akvareg <-load_by_sheet(path, page = 4) 
akvareg <- akvareg %>%  mutate(LOK_NR = as.numeric(LOK_NR))
licenses <-read.csv("data/aquaculture_lisences_northnorway_2010_2018.csv")
komlist <-read.csv("../../administrative/komlist.csv", sep = ";")
komlist <-filter(komlist, !Name=="NonCoast") %>%  
    mutate(Name = fct_drop(as.character(Name)))
```

# Further preparation of momb data
```{r}
momb_prep2 <-  momb_prep %>% 
  mutate(Year = lubridate::year(dato_provetaking)) %>% 
  select(-c("mom_type", "reference")) %>% 
  rename("Kommune" = "akvareg_lok_kom", "Komnum" = "akvareg_lok_komnr") %>% 
  left_join(komlist[,c(1,2)], by = "Komnum") %>% 
  mutate(Kommune = Name) %>% 
  select(-Name)
  

map(momb_prep2, ~sum(is.na(.x))) #Still 93 locations did not have info on the municipality where they are located.

momb_prep3 <- momb_prep2 %>% 
  filter(!is.na(Kommune)) 
```
Regarding localities with no municipality info: they are either shut down or have not yet given licence to start the produciton (commented by Fisheries Directorate). Thus, I delete these locaitons. 

## Check how many examined aquaculture localities per municipality each year and compare to total
```{r}
names(licenses) <- gsub("Ø", names(licenses), replacement = "O") %>%
  gsub("Å", ., replacement = "A") %>%
  str_to_lower(.)

totlocs_mp <- licenses %>%
  filter(vannmiljo == "SALTVANN") %>%
  group_by(year, till_komnr, till_kom) %>%
  summarize(nlocs = n_distinct(lok_nr)) %>% 
  rename(Year = year, Komnum = till_komnr,Kommune = till_kom)

#Examinations per year per municipality
examinations_year <- momb_prep3 %>% 
  group_by(Year, Kommune, Komnum) %>% 
  summarize(examinations = n_distinct(loknr)) %>% 
  left_join(totlocs_mp, by = c("Year", "Komnum"))

#Compare the number of examinations to the total number of registered localities
#There are no cases when all registered localities were examined.
examinations_filtered <- filter(examinations_year, !is.na(nlocs))
examinations <-examinations_filtered$examinations
totals <-examinations_filtered$nlocs

for (i in length(examinations)) {
 print(examinations[examinations == totals])
  }
```

# Preparing final  table: average momb per municipality and year
```{r}
momb_prep4 <- momb_prep3 %>%
  mutate(mombtrans = case_when(
    miljo_tilstand == 1 ~ "1",
    miljo_tilstand == 2 ~ "0.66",
    miljo_tilstand == 3 ~ "0.33",
    miljo_tilstand == 4 ~ "0"
  )) %>%
  mutate(mombtrans = as.numeric(mombtrans)) %>%
  group_by(Year, Komnum, Kommune) %>%
  summarize(momb_mean = mean(mombtrans))
```


# Gapfilling missing year of momb data
## Creating a fucntion to gapfill
The idea is to take an average of the 5 recent years witn data. 
Often, there will only be 5 years with data - then we just take average of those.
```{r include = FALSE}
#Just another version of the funciton
gapfill <- function(df) {
  if (all(is.na(df[, 2]))) {
    warning("there are no numeric values in the data", call. = FALSE)
    finaldf <-df
  } else if (sum(is.na(df[, 2])) <= 5) {
    cleandat <- drop_na(df)
    cleandat_sort <- arrange(cleandat, cleandat[, 1])
    replacement <- mean(tail(cleandat, 3)[, 2], na.rm = T)
    replaced <- replace_na(df[, 2], replacement)
    finaldf <- cbind(df[, 1], replaced)
    colnames(finaldf) <- names(df)
  } else {
    cleandat <- drop_na(df)
    cleandat_sort <- arrange(cleandat, cleandat[, 1])
    replacement <- mean(tail(cleandat, 5)[, 2], na.rm = T)
    replaced <- replace_na(df[, 2], replacement)
    finaldf <- cbind(df[, 1], replaced)
    colnames(finaldf) <- names(df)
  }

  finaldf
}
```


```{r}
gapfill <- function(df, id_col, miss_col) {
    if (all(is.na(df[, miss_col]))) {
    warning("there are no numeric values in the data", call. = FALSE)
    finaldf <-df 
    } else if (sum(is.na(df[,miss_col])) <= 5) {
      cleandat <- drop_na(df, miss_col)
      cleandat_sort <- arrange(cleandat, cleandat[,id_col])
      replacement <- mean(tail(cleandat, 3)[,miss_col], na.rm = T)
      replaced <- replace_na(df[,miss_col], replacement)
      finaldf <- cbind(df, replaced)
   
    } else {
      cleandat <- drop_na(df, miss_col)
      cleandat_sort <- arrange(cleandat, cleandat[,id_col])
      replacement <- mean(tail(cleandat, 5)[,miss_col], na.rm = T)
      replaced <- replace_na(df[,miss_col], replacement)
      finaldf <- cbind(df, replaced)
 
    }

  finaldf
}


```


## Gapfilling missing years per municipality
```{r}
municips <- split(momb_prep4, momb_prep4$Kommune)

#check if there are municipalities with empty rows.
#There are 14 of such municipalities
empties<- map(municips, ~ isTRUE(length(.x$momb_mean)==0))
empty_municips <-unlist(empties) 

#the list of municipalities that did not have any momb data
empties_list <- unlist(empties) %>% 
 stack(.) %>% 
 filter(values==TRUE)

municips_cleaned <-municips[!empty_municips]
```

## Compiling final dataframe
```{r}
allyears <-data.frame(Year = seq(2004, 2019, by = 1))

municip_prep <- map(municips_cleaned, ~ as.data.frame(.x)) %>%
  map(., ~ full_join(.x, allyears, by = "Year")) %>% 
  map(., ~ mutate(.x, Komnum_new = rep(Komnum[1], length(Komnum)))) %>% 
  map(., ~ mutate(.x, Kommune_new = rep(Kommune[1], length(Kommune)))) %>% 
  map(., ~ select(.x,-c(Komnum, Kommune))) %>% 
  map(., ~ gapfill(.x, 1,2)) 

momb_gapfilled <- do.call("rbind", municip_prep) 

#write_csv(momb_gapfilled, "data/mean_momb_mpyr.csv")
```




